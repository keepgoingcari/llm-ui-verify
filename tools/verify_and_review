#!/usr/bin/env bash
set -euo pipefail

# Pass all args to verify_flow; it will prompt for missing inputs.
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

CHANGE=""
RUN_DIR=""
MODEL="gpt-4.1-mini"
MAX_FRAMES="12"
TAIL_FRAMES="6"
DETAIL="low"

PASS_ARGS=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    --change)
      CHANGE="$2"; PASS_ARGS+=("$1" "$2"); shift 2;;
    --run-dir)
      RUN_DIR="$2"; shift 2;;
    --model)
      MODEL="$2"; shift 2;;
    --max-frames)
      MAX_FRAMES="$2"; shift 2;;
    --tail-frames)
      TAIL_FRAMES="$2"; shift 2;;
    --detail)
      DETAIL="$2"; shift 2;;
    *)
      PASS_ARGS+=("$1"); shift 1;;
  esac
done

if [[ -z "$RUN_DIR" ]]; then
  "$ROOT_DIR/tools/verify_flow" "${PASS_ARGS[@]}"
  RUN_DIR="$ROOT_DIR/runs/$(ls -t "$ROOT_DIR/runs" | head -n 1)"
fi

if [[ -z "$CHANGE" ]]; then
  read -r -p "Intended change (short description): " CHANGE
fi

"$ROOT_DIR/scripts/llm_verify.py" \
  --run-dir "$RUN_DIR" \
  --change "$CHANGE" \
  --model "$MODEL" \
  --max-frames "$MAX_FRAMES" \
  --tail-frames "$TAIL_FRAMES" \
  --detail "$DETAIL"
